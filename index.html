<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigTicket ‚Äî Dashboard de Escaneos</title>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --orange: #FF6600;
            --orange-dark: #CC4F00;
            --orange-light: #FF8533;
            --orange-pale: #FFF0E6;
            --black: #1A1A1A;
            --gray-dark: #2D2D2D;
            --gray-mid: #666;
            --gray-light: #E8E8E8;
            --white: #FFFFFF;
            --green: #2ECC71;
            --yellow: #F39C12;
            --red: #E74C3C;
            --blue: #3498DB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Barlow', sans-serif;
            background: #F4F4F4;
            color: var(--black);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            background: var(--black);
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid var(--orange);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: var(--orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 800;
            font-size: 22px;
            color: var(--white);
            letter-spacing: 0.5px;
        }

        .logo-text span { color: var(--orange); }

        .header-subtitle {
            font-size: 12px;
            color: #888;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-refresh {
            background: transparent;
            border: 1px solid #444;
            color: #CCC;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'Barlow', sans-serif;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-refresh:hover { border-color: var(--orange); color: var(--orange); }

        .last-update {
            font-size: 12px;
            color: #666;
        }

        /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 28px 24px;
        }

        /* ‚îÄ‚îÄ FILTERS BAR ‚îÄ‚îÄ */
        .filters-bar {
            background: var(--white);
            border-radius: 12px;
            padding: 18px 24px;
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-light);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-mid);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .filter-group input,
        .filter-group select {
            border: 1.5px solid var(--gray-light);
            border-radius: 7px;
            padding: 8px 12px;
            font-size: 14px;
            font-family: 'Barlow', sans-serif;
            color: var(--black);
            background: var(--white);
            min-width: 150px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--orange);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn {
            padding: 9px 18px;
            border-radius: 7px;
            border: none;
            cursor: pointer;
            font-family: 'Barlow', sans-serif;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--orange); color: white; }
        .btn-primary:hover { background: var(--orange-dark); }
        .btn-outline { background: transparent; border: 1.5px solid var(--gray-light); color: var(--gray-mid); }
        .btn-outline:hover { border-color: var(--orange); color: var(--orange); }
        .btn-export { background: var(--black); color: white; }
        .btn-export:hover { background: var(--gray-dark); }

        /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--white);
            border-radius: 12px;
            padding: 22px 24px;
            border: 1px solid var(--gray-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }

        .kpi-card.orange::before { background: var(--orange); }
        .kpi-card.green::before { background: var(--green); }
        .kpi-card.yellow::before { background: var(--yellow); }
        .kpi-card.blue::before { background: var(--blue); }

        .kpi-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 42px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
            color: var(--black);
        }

        .kpi-card.orange .kpi-value { color: var(--orange); }
        .kpi-card.green .kpi-value { color: var(--green); }
        .kpi-card.yellow .kpi-value { color: var(--yellow); }
        .kpi-card.blue .kpi-value { color: var(--blue); }

        .kpi-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-mid);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* ‚îÄ‚îÄ CHARTS ROW ‚îÄ‚îÄ */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--gray-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--black);
        }

        .chart-badge {
            font-size: 12px;
            font-weight: 600;
            color: var(--orange);
            background: var(--orange-pale);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .chart-container {
            height: 240px;
            position: relative;
        }

        /* ‚îÄ‚îÄ TABLE SECTION ‚îÄ‚îÄ */
        .table-section {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--gray-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-light);
            flex-wrap: wrap;
            gap: 12px;
        }

        .table-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 17px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-search {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            border: 1.5px solid var(--gray-light);
            border-radius: 7px;
            padding: 7px 12px;
            font-size: 13px;
            font-family: 'Barlow', sans-serif;
            min-width: 200px;
            transition: border-color 0.2s;
        }

        .search-input:focus { outline: none; border-color: var(--orange); }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            background: #F9F9F9;
        }

        th {
            padding: 12px 20px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--gray-mid);
            border-bottom: 1px solid var(--gray-light);
        }

        td {
            padding: 13px 20px;
            font-size: 14px;
            border-bottom: 1px solid #F2F2F2;
            vertical-align: middle;
        }

        tbody tr:hover { background: var(--orange-pale); transition: background 0.15s; }
        tbody tr:last-child td { border-bottom: none; }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success { background: #E8F8EF; color: #1B8C4A; }
        .badge-warning { background: #FFF3CD; color: #856404; }

        .btn-detalle {
            background: var(--black);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-family: 'Barlow', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-detalle:hover { background: var(--orange); }

        /* ‚îÄ‚îÄ LOADING / EMPTY / ERROR ‚îÄ‚îÄ */
        .state-container {
            padding: 60px 20px;
            text-align: center;
            color: var(--gray-mid);
        }

        .state-icon { font-size: 48px; margin-bottom: 16px; }
        .state-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .state-desc { font-size: 14px; color: #999; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-light);
            border-top-color: var(--orange);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(3px);
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 760px;
            max-height: 88vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 80px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: var(--black);
            padding: 20px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--orange);
        }

        .modal-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-modal-export {
            background: var(--orange);
            color: white;
            border: none;
            border-radius: 7px;
            padding: 8px 16px;
            font-family: 'Barlow', sans-serif;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-modal-export:hover { background: var(--orange-dark); }

        .btn-close {
            background: transparent;
            border: 1px solid #444;
            color: #CCC;
            width: 34px;
            height: 34px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close:hover { border-color: var(--orange); color: var(--orange); }

        .modal-body {
            overflow-y: auto;
            padding: 28px;
            flex: 1;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--orange);
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-light);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .detail-item {
            background: #F9F9F9;
            border-radius: 8px;
            padding: 12px 16px;
        }

        .detail-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-mid);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .kpi-mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .kpi-mini {
            background: var(--orange-pale);
            border-radius: 8px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255,102,0,0.2);
        }

        .kpi-mini-val {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 32px;
            font-weight: 800;
            color: var(--orange);
        }

        .kpi-mini-lbl {
            font-size: 11px;
            color: var(--gray-mid);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .codigos-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .codigos-table th {
            background: #F2F2F2;
            padding: 9px 14px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--gray-mid);
            border: none;
        }

        .codigos-table td {
            padding: 9px 14px;
            border-bottom: 1px solid #F2F2F2;
        }

        .codigos-table tbody tr:last-child td { border-bottom: none; }

        .sin-cargas-alert {
            background: #FFF9E6;
            border: 1.5px solid #F39C12;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .sin-cargas-alert .alert-icon { font-size: 36px; margin-bottom: 10px; }
        .sin-cargas-alert h3 { color: #856404; font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; }
        .sin-cargas-alert p { color: #997404; font-size: 13px; margin-top: 8px; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .header-subtitle { display: none; }
        }

        @media (max-width: 600px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .filter-actions { margin-left: 0; width: 100%; }
            .filters-bar { flex-direction: column; align-items: stretch; }
            .filter-group input, .filter-group select { min-width: unset; width: 100%; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="header-logo">
        <div class="logo-icon">üöö</div>
        <div>
            <div class="logo-text"><span>big</span>ticket</div>
            <div class="header-subtitle">Dashboard de Escaneos</div>
        </div>
    </div>
    <div class="header-right">
        <span class="last-update" id="lastUpdate">‚Äî</span>
        <button class="btn-refresh" onclick="cargarDatos()">
            üîÑ Actualizar
        </button>
    </div>
</header>

<!-- MAIN -->
<div class="main">

    <!-- FILTERS -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Fecha Desde</label>
            <input type="date" id="fechaDesde">
        </div>
        <div class="filter-group">
            <label>Fecha Hasta</label>
            <input type="date" id="fechaHasta">
        </div>
        <div class="filter-group">
            <label>Bodega</label>
            <select id="filtroBodega">
                <option value="">Todas las bodegas</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Filtrar</button>
            <button class="btn btn-outline" onclick="limpiarFiltros()">‚úï Limpiar</button>
            <button class="btn btn-export" onclick="exportarResumen()">‚¨á Exportar</button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card orange">
            <div class="kpi-icon">üìã</div>
            <div class="kpi-value" id="kpiReportes">‚Äî</div>
            <div class="kpi-label">Total Reportes</div>
        </div>
        <div class="kpi-card green">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-value" id="kpiBultos">‚Äî</div>
            <div class="kpi-label">Bultos Retirados</div>
        </div>
        <div class="kpi-card yellow">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-value" id="kpiSinCarga">‚Äî</div>
            <div class="kpi-label">D√≠as Sin Carga</div>
        </div>
        <div class="kpi-card blue">
            <div class="kpi-icon">üîÅ</div>
            <div class="kpi-value" id="kpiMultibultos">‚Äî</div>
            <div class="kpi-label">Multibultos</div>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-row">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Bultos por D√≠a</div>
                <span class="chart-badge" id="chartDiasBadge">√öltimos 6 d√≠as</span>
            </div>
            <div class="chart-container">
                <canvas id="chartDias"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Distribuci√≥n por Bodega</div>
                <span class="chart-badge" id="chartBodegaBadge">‚Äî</span>
            </div>
            <div class="chart-container">
                <canvas id="chartBodega"></canvas>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="table-section">
        <div class="table-header">
            <div class="table-title">üìã √öltimos Reportes</div>
            <div class="table-search">
                <input type="date" class="search-input" id="buscarFecha" placeholder="Buscar por fecha" onchange="filtrarPorFecha()">
                <button class="btn btn-outline" onclick="limpiarBusqueda()" style="padding:7px 12px; font-size:12px;">‚úï</button>
            </div>
        </div>
        <div id="tableContainer">
            <div class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Cargando datos...</div>
                <div class="state-desc">Conectando con Google Sheets</div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL DETALLE -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Detalle del Reporte</div>
            <div class="modal-actions">
                <button class="btn-modal-export" onclick="exportarDetalleExcel()">‚¨á Descargar Excel</button>
                <button class="btn-close" onclick="cerrarModalBtn()">‚úï</button>
            </div>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
    // ‚îÄ‚îÄ CONFIGURACI√ìN ‚îÄ‚îÄ
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwjaua58YgR8oaGO55GSft3T-0igvuI4ogesjoNme-J_xmhGkvzNr1FPGfSnhqJBr1egQ/exec';
    const COLORES_BODEGA = ['#FF6600','#CC4F00','#FF8533','#FFB380','#FFA366','#FFD4B3','#E65C00','#FF9933'];

    let todosLosReportes = [];
    let reportesFiltrados = [];
    let charts = {};
    let reporteActual = null;
    let reportesFiltradosTabla = [];

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
    window.addEventListener('load', () => {
        inicializarFechas();
        cargarDatos();
    });

    function inicializarFechas() {
        const hoy = new Date();
        const hace30 = new Date();
        hace30.setDate(hoy.getDate() - 30);
        document.getElementById('fechaDesde').value = hace30.toISOString().split('T')[0];
        document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
    }

    // ‚îÄ‚îÄ CARGA DE DATOS ‚îÄ‚îÄ
    async function cargarDatos() {
        document.getElementById('tableContainer').innerHTML = `
            <div class="state-container">
                <div class="spinner"></div>
                <div class="state-title">Cargando datos...</div>
                <div class="state-desc">Conectando con Google Sheets</div>
            </div>`;

        try {
            const response = await fetch(SHEET_URL);
            if (!response.ok) throw new Error('Error de conexi√≥n');
            const data = await response.json();

            if (data.success && data.reportes) {
                // Normalizar todas las fechas: quitar parte de hora si viene como ISO
                todosLosReportes = data.reportes.map(r => ({
                    ...r,
                    fecha: r.fecha ? r.fecha.split('T')[0] : r.fecha,
                    fecha_firma: r.fecha_firma ? r.fecha_firma.split('T')[0] : r.fecha_firma
                }));
                reportesFiltrados = [...todosLosReportes];
                actualizarDashboard();
                document.getElementById('lastUpdate').textContent =
                    'Actualizado: ' + new Date().toLocaleTimeString('es-CL');
            } else {
                throw new Error('Sin datos');
            }
        } catch (err) {
            document.getElementById('tableContainer').innerHTML = `
                <div class="state-container">
                    <div class="state-icon">‚ùå</div>
                    <div class="state-title">Error al conectar</div>
                    <div class="state-desc">Verifica la URL del Apps Script o intenta nuevamente</div>
                    <br>
                    <button class="btn btn-primary" onclick="cargarDatos()">üîÑ Reintentar</button>
                </div>`;
        }
    }

    // ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ
    function aplicarFiltros() {
        const desde = document.getElementById('fechaDesde').value;
        const hasta = document.getElementById('fechaHasta').value;
        const bodega = document.getElementById('filtroBodega').value;

        reportesFiltrados = todosLosReportes.filter(r => {
            const okFecha = (!desde || r.fecha >= desde) && (!hasta || r.fecha <= hasta);
            const okBodega = !bodega || r.bodega === bodega;
            return okFecha && okBodega;
        });

        actualizarDashboard();
    }

    function limpiarFiltros() {
        inicializarFechas();
        document.getElementById('filtroBodega').value = '';
        document.getElementById('buscarFecha').value = '';
        reportesFiltrados = [...todosLosReportes];
        actualizarDashboard();
    }

    function filtrarPorFecha() {
        const fecha = document.getElementById('buscarFecha').value;
        if (!fecha) {
            reportesFiltradosTabla = reportesFiltrados;
        } else {
            // Comparar solo la parte de fecha (por si alg√∫n registro tiene hora)
            reportesFiltradosTabla = reportesFiltrados.filter(r => {
                const fechaReporte = r.fecha ? r.fecha.split('T')[0] : '';
                return fechaReporte === fecha;
            });
        }
        renderTabla(reportesFiltradosTabla);
    }

    function limpiarBusqueda() {
        document.getElementById('buscarFecha').value = '';
        reportesFiltradosTabla = reportesFiltrados;
        renderTabla(reportesFiltradosTabla);
    }

    // ‚îÄ‚îÄ ACTUALIZAR DASHBOARD ‚îÄ‚îÄ
    function actualizarDashboard() {
        actualizarKPIs();
        actualizarFiltroBodegas();
        actualizarGraficosDias();
        actualizarGraficoBodega();
        reportesFiltradosTabla = reportesFiltrados;
        renderTabla(reportesFiltrados);
    }

    // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
    function actualizarKPIs() {
        const totalReportes = reportesFiltrados.length;
        const totalBultos = reportesFiltrados.reduce((s, r) => s + (r.total_escaneos || 0), 0);
        const sinCarga = reportesFiltrados.filter(r => r.sin_cargas).length;
        const multibultos = reportesFiltrados.reduce((s, r) => s + (r.multibultos || 0), 0);

        animarNumero('kpiReportes', totalReportes);
        animarNumero('kpiBultos', totalBultos);
        animarNumero('kpiSinCarga', sinCarga);
        animarNumero('kpiMultibultos', multibultos);
    }

    function animarNumero(id, target) {
        const el = document.getElementById(id);
        const start = parseInt(el.textContent) || 0;
        const duration = 500;
        const startTime = performance.now();

        function update(now) {
            const progress = Math.min((now - startTime) / duration, 1);
            const ease = 1 - Math.pow(1 - progress, 3);
            el.textContent = Math.round(start + (target - start) * ease).toLocaleString();
            if (progress < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
    }

    // ‚îÄ‚îÄ GR√ÅFICO D√çAS ‚îÄ‚îÄ 6 d√≠as centrado en hoy
    function actualizarGraficosDias() {
        const hoy = new Date();
        const dias = [];
        for (let i = -3; i <= 3; i++) {
            const d = new Date(hoy);
            d.setDate(hoy.getDate() + i);
            dias.push(d.toISOString().split('T')[0]);
        }

        // Agrupar bultos por d√≠a de los reportes filtrados
        const bultosPorDia = {};
        reportesFiltrados.forEach(r => {
            bultosPorDia[r.fecha] = (bultosPorDia[r.fecha] || 0) + (r.total_escaneos || 0);
        });

        const labels = dias.map(d => {
            const [, mes, dia] = d.split('-');
            return `${dia}/${mes}`;
        });
        const valores = dias.map(d => bultosPorDia[d] || 0);

        // Colores: hoy en naranja, resto m√°s suave
        const hoySt = hoy.toISOString().split('T')[0];
        const bgColors = dias.map(d => d === hoySt ? 'rgba(255,102,0,1)' : 'rgba(255,102,0,0.25)');
        const borderColors = dias.map(d => d === hoySt ? '#CC4F00' : 'rgba(255,102,0,0.4)');

        if (charts['chartDias']) charts['chartDias'].destroy();

        charts['chartDias'] = new Chart(document.getElementById('chartDias'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Bultos',
                    data: valores,
                    backgroundColor: 'rgba(255,102,0,0.12)',
                    borderColor: '#FF6600',
                    borderWidth: 2.5,
                    pointBackgroundColor: bgColors,
                    pointBorderColor: borderColors,
                    pointRadius: dias.map(d => d === hoySt ? 8 : 5),
                    pointHoverRadius: 8,
                    tension: 0.35,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const idx = items[0].dataIndex;
                                return dias[idx] === hoySt ? `${labels[idx]} (Hoy)` : labels[idx];
                            },
                            label: (item) => ` ${item.raw} bultos`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#F0F0F0' },
                        ticks: {
                            font: { family: 'Barlow', size: 12 },
                            color: '#999',
                            precision: 0,
                            stepSize: 1,
                            callback: (val) => Number.isInteger(val) ? val : null
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: 'Barlow', size: 12 }, color: '#999' }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ GR√ÅFICO TORTA BODEGA ‚îÄ‚îÄ
    function actualizarGraficoBodega() {
        const bultosPorBodega = {};
        reportesFiltrados.forEach(r => {
            if (!r.sin_cargas) {
                bultosPorBodega[r.bodega] = (bultosPorBodega[r.bodega] || 0) + (r.total_escaneos || 0);
            }
        });

        const labels = Object.keys(bultosPorBodega);
        const valores = Object.values(bultosPorBodega);
        const total = valores.reduce((a, b) => a + b, 0);

        document.getElementById('chartBodegaBadge').textContent =
            total > 0 ? `${total.toLocaleString()} bultos` : 'Sin datos';

        if (charts['chartBodega']) charts['chartBodega'].destroy();

        if (labels.length === 0) {
            document.getElementById('chartBodega').parentElement.innerHTML =
                '<div style="height:240px;display:flex;align-items:center;justify-content:center;color:#CCC;font-size:14px;">Sin datos para mostrar</div>';
            return;
        }

        charts['chartBodega'] = new Chart(document.getElementById('chartBodega'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: valores,
                    backgroundColor: COLORES_BODEGA.slice(0, labels.length),
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '62%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { family: 'Barlow', size: 12 },
                            color: '#444',
                            boxWidth: 12,
                            padding: 10,
                            generateLabels: (chart) => {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: `${label.length > 18 ? label.substring(0, 18) + '‚Ä¶' : label} (${data.datasets[0].data[i]})`,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (item) => ` ${item.raw} bultos (${((item.raw / total) * 100).toFixed(1)}%)`
                        }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ
    function actualizarFiltroBodegas() {
        const bodegas = [...new Set(todosLosReportes.map(r => r.bodega))].sort();
        const select = document.getElementById('filtroBodega');
        const actual = select.value;
        select.innerHTML = '<option value="">Todas las bodegas</option>' +
            bodegas.map(b => `<option value="${b}">${b}</option>`).join('');
        select.value = actual;
    }

    function renderTabla(reportes) {
        const ultimos10 = reportes.slice(-10).reverse();

        if (ultimos10.length === 0) {
            document.getElementById('tableContainer').innerHTML = `
                <div class="state-container">
                    <div class="state-icon">üì≠</div>
                    <div class="state-title">Sin resultados</div>
                    <div class="state-desc">No hay reportes para los filtros seleccionados</div>
                </div>`;
            return;
        }

        const html = `
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Bodega</th>
                        <th>Encargado</th>
                        <th>Bultos</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${ultimos10.map(r => `
                        <tr>
                            <td><strong>${r.fecha ? r.fecha.split("T")[0] : "‚Äî"}</strong></td>
                            <td style="color:#888">${r.hora_generacion || r.hora || '‚Äî'}</td>
                            <td>${r.bodega}</td>
                            <td>${r.encargado || '‚Äî'}</td>
                            <td><strong style="color: var(--orange)">${r.total_escaneos || 0}</strong></td>
                            <td>
                                <span class="badge ${r.sin_cargas ? 'badge-warning' : 'badge-success'}">
                                    ${r.sin_cargas ? '‚ö† Sin Carga' : '‚úì Completado'}
                                </span>
                            </td>
                            <td>
                                <button class="btn-detalle" onclick='verDetalle(${JSON.stringify(r).replace(/'/g, "&#39;")})'>
                                    Ver detalle
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="padding:12px 20px; font-size:12px; color:#999; border-top:1px solid #F2F2F2;">
                Mostrando los √∫ltimos ${ultimos10.length} de ${reportes.length} reportes
            </div>`;

        document.getElementById('tableContainer').innerHTML = html;
    }

    // ‚îÄ‚îÄ MODAL DETALLE ‚îÄ‚îÄ
    function verDetalle(reporte) {
        reporteActual = reporte;
        document.getElementById('modalTitle').textContent =
            `Reporte ‚Äî ${reporte.fecha} ¬∑ ${reporte.bodega}`;

        let html = `
            <!-- KPIs mini -->
            <div class="kpi-mini-grid">
                <div class="kpi-mini">
                    <div class="kpi-mini-val">${reporte.total_escaneos || 0}</div>
                    <div class="kpi-mini-lbl">Total Escaneos</div>
                </div>
                <div class="kpi-mini">
                    <div class="kpi-mini-val">${reporte.bultos_unicos || 0}</div>
                    <div class="kpi-mini-lbl">Bultos √önicos</div>
                </div>
                <div class="kpi-mini">
                    <div class="kpi-mini-val">${reporte.multibultos || 0}</div>
                    <div class="kpi-mini-lbl">Multibultos</div>
                </div>
            </div>

            <!-- Info general -->
            <div class="detail-section">
                <h3>üìã Informaci√≥n General</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Fecha</div>
                        <div class="detail-value">${reporte.fecha}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Hora de Generaci√≥n</div>
                        <div class="detail-value">${reporte.hora_generacion || reporte.hora || '‚Äî'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bodega</div>
                        <div class="detail-value">${reporte.bodega}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Estado</div>
                        <div class="detail-value">
                            <span class="badge ${reporte.sin_cargas ? 'badge-warning' : 'badge-success'}">
                                ${reporte.sin_cargas ? '‚ö† Sin Carga' : '‚úì Completado'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Firma -->
            <div class="detail-section">
                <h3>‚úçÔ∏è Firma de Recepci√≥n</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Encargado</div>
                        <div class="detail-value">${reporte.encargado || 'SIN FIRMA'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Fecha de Firma</div>
                        <div class="detail-value">${reporte.fecha_firma || reporte.fecha || '‚Äî'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Hora de Firma</div>
                        <div class="detail-value">${reporte.hora_firma || '‚Äî'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Fotograf√≠a</div>
                        <div class="detail-value">${reporte.tiene_foto ? '‚úÖ S√≠' : '‚ùå No'}</div>
                    </div>
                </div>
            </div>`;

        // C√≥digos escaneados o sin cargas
        if (reporte.sin_cargas) {
            html += `
            <div class="sin-cargas-alert">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <h3>Sin Cargas Disponibles</h3>
                <p>El transporte lleg√≥ a la bodega pero no hab√≠a paquetes disponibles para cargar.<br>Este reporte sirve como evidencia de la visita.</p>
            </div>`;
        } else if (reporte.codigos && Object.keys(reporte.codigos).length > 0) {
            const codigos = Object.entries(reporte.codigos)
                .map(([c, q]) => ({ codigo: c, cantidad: q }))
                .sort((a, b) => b.cantidad - a.cantidad);

            html += `
            <div class="detail-section">
                <h3>üì¶ C√≥digos Escaneados (${codigos.length} √∫nicos)</h3>
                <table class="codigos-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo</th>
                            <th>Cantidad</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${codigos.map((item, i) => `
                            <tr>
                                <td style="color:#999">${i + 1}</td>
                                <td><strong>${item.codigo}</strong></td>
                                <td>${item.cantidad}</td>
                                <td>
                                    <span class="badge ${item.cantidad > 1 ? 'badge-warning' : 'badge-success'}">
                                        ${item.cantidad > 1 ? 'Multibulto' : '√önico'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('modalOverlay').classList.add('show');
    }

    function cerrarModal(event) {
        if (event.target === document.getElementById('modalOverlay')) {
            document.getElementById('modalOverlay').classList.remove('show');
        }
    }

    function cerrarModalBtn() {
        document.getElementById('modalOverlay').classList.remove('show');
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') cerrarModalBtn();
    });

    // ‚îÄ‚îÄ EXPORTAR DETALLE A EXCEL ‚îÄ‚îÄ
    function exportarDetalleExcel() {
        if (!reporteActual) return;
        const r = reporteActual;
        const wb = XLSX.utils.book_new();

        const resumen = [
            ['BIGTICKET LOG√çSTICA Y TRANSPORTE'],
            ['DETALLE DE REPORTE DE ESCANEO'],
            [''],
            ['Fecha:', r.fecha],
            ['Hora:', r.hora_generacion || r.hora || '‚Äî'],
            ['Bodega:', r.bodega],
            ['Encargado:', r.encargado || 'SIN FIRMA'],
            ['Fecha Firma:', r.fecha_firma || '‚Äî'],
            ['Hora Firma:', r.hora_firma || '‚Äî'],
            ['Fotograf√≠a:', r.tiene_foto ? 'S√≠' : 'No'],
            [''],
            ['Total Escaneos:', r.total_escaneos || 0],
            ['Bultos √önicos:', r.bultos_unicos || 0],
            ['Multibultos:', r.multibultos || 0],
            ['Estado:', r.sin_cargas ? 'Sin Cargas' : 'Completado'],
        ];

        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumen), 'Resumen');

        if (!r.sin_cargas && r.codigos && Object.keys(r.codigos).length > 0) {
            const rows = [['#', 'C√ìDIGO', 'CANTIDAD', 'TIPO']];
            Object.entries(r.codigos)
                .sort((a, b) => b[1] - a[1])
                .forEach(([codigo, cantidad], i) => {
                    rows.push([i + 1, codigo, cantidad, cantidad > 1 ? 'Multibulto' : '√önico']);
                });
            rows.push([], ['Total √önicos:', Object.keys(r.codigos).length], ['Total Escaneos:', r.total_escaneos]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), 'C√≥digos');
        }

        const nombre = `Reporte_${r.bodega.replace(/[\\/]/g, '-')}_${r.fecha}.xlsx`;
        XLSX.writeFile(wb, nombre);
    }

    // ‚îÄ‚îÄ EXPORTAR RESUMEN GENERAL ‚îÄ‚îÄ
    function exportarResumen() {
        if (reportesFiltrados.length === 0) { alert('No hay datos para exportar.'); return; }

        const rows = [['FECHA', 'HORA', 'BODEGA', 'ENCARGADO', 'TOTAL ESCANEOS', 'BULTOS √öNICOS', 'MULTIBULTOS', 'ESTADO']];
        reportesFiltrados.forEach(r => {
            rows.push([
                r.fecha, r.hora_generacion || r.hora || '‚Äî', r.bodega, r.encargado || '‚Äî',
                r.total_escaneos || 0, r.bultos_unicos || 0, r.multibultos || 0,
                r.sin_cargas ? 'Sin Cargas' : 'Completado'
            ]);
        });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), 'Reportes');
        XLSX.writeFile(wb, `BigTicket_Reportes_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
</script>
</body>
</html>
